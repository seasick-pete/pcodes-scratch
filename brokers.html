<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OS Names API | Find Place Example | OpenLayers</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/OrdnanceSurvey/os-api-branding@latest/os-api-branding.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.6.0/ol.css" />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>

<style>
    .map-overlay {
        font: 14px/20px Arial, Helvetica, sans-serif;
        position: absolute;
        top: 0;
        left: 0;
        width: 300px;
        padding: 10px;
        z-index: 9999;
    }
    .map-overlay-inner {
        background-color: #fff;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        padding: 10px;
    }
    .map-overlay-inner div {
        margin-top: 8px;
        display: block;
    }
    .map-overlay-inner span {
        font-weight: 600;
    }
    .map-overlay-inner .uri {
        color: #ccc;
        word-break: break-all;
    }
    .ol-popup {
        position: fixed;
        background-color: white;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #ccc;
        bottom: 12px;
        left: -50px;
        width: max-content;
        max-width: 260px;
        cursor: auto;
    }
    .ol-popup:after, .ol-popup:before {
        top: 100%;
        border: solid transparent;
        content: " ";
        height: 0;
        width: 0;
        position: absolute;
        pointer-events: none;
    }
    .ol-popup:after {
        border-top-color: white;
        border-width: 10px;
        left: 48px;
        margin-left: -10px;
    }
    .ol-popup:before {
        border-top-color: #ccc;
        border-width: 11px;
        left: 48px;
        margin-left: -11px;
    }
    .ol-popup-closer {
        text-decoration: none;
        position: absolute;
        top: 2px;
        right: 8px;
        color: #333;
        font-size: smaller;
    }
    .ol-popup-closer:after {
        content: "âœ–";
    }
    .grid-container {
        display: grid;
        grid-template-columns: max-content max-content;
        grid-gap: 0 8px;
    }
    #popup-content {
        font: 12px/1.5 Arial, Helvetica, sans-serif;
        margin-right: 10px;
        max-height: 200px;
        overflow: auto;
    }
</style>

<div id="map"></div>
<div id="popup" class="ol-popup">
    <a href="#" id="popup-closer" class="ol-popup-closer"></a>
    <div id="popup-content"></div>
</div>
<div class="map-overlay">
    <div class="map-overlay-inner">
        <input id="query" type="radio" name="find" value="&query=Shirley" checked="checked">
        <label for="query">Find (basic)</label><br>
        <input id="query-bounds" type="radio" name="find" value="&query=Shirley&bounds=400000,100000,500000,200000">
        <label for="query-bounds">Find (bounds biased)</label><br>
        <input id="query-fq-bbox" type="checkbox" name="filter" value="&fq=BBOX:440000,113000,441000,114000">
        <label for="query-fq-bbox">Apply BBOX filter</label><br>
        <input id="query-fq-localtype" type="checkbox" name="filter" value="&fq=LOCAL_TYPE:Suburban_Area">
        <label for="query-fq-localtype">Apply LOCAL_TYPE filter</label>
        <div>Total results: <span id="results"></span></div>
        <div class="uri"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/OrdnanceSurvey/os-api-branding@latest/os-api-branding.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ol@v10.6.0/dist/ol.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.19.0/proj4.min.js"></script>
<script>

    const apiKey = 'tXVGmsJc4og29x50rf8JOl5yI70JVT6K';

    // Set default query and filter parameter values.
    let queryString = document.getElementById('query').value,
        bboxFilter = '',
        localTypeFilter = '';

    // Setup the EPSG:27700 (British National Grid) projection.
    proj4.defs("EPSG:27700", "+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +towgs84=446.448,-125.157,542.06,0.15,0.247,0.842,-20.489 +units=m +no_defs");
    ol.proj.proj4.register(proj4);

    // Initialize the map object.
    const map = new ol.Map({
        layers: [
            new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: 'https://api.os.uk/maps/raster/v1/zxy/Light_3857/{z}/{x}/{y}.png?key=' + apiKey
                })
            })
        ],
        target: 'map',
        view: new ol.View({
            projection: 'EPSG:3857',
            extent: ol.proj.transformExtent([ -10.76418, 49.528423, 1.9134116, 61.331151 ], 'EPSG:4326', 'EPSG:3857'),
            minZoom: 7,
            maxZoom: 16,
            center: ol.proj.fromLonLat([ -1.452, 50.924 ]),
            zoom: 13
        }),
        interactions: new ol.Collection(),
        controls: ol.control.defaults.defaults({
            zoom: true
        })
    });

    // Add a layer for rendering the point features on the map.
    const markerSource = new ol.source.Vector();
    const markerLayer = new ol.layer.Vector({
        source: markerSource,
        style: new ol.style.Style({
            image: new ol.style.Circle({
                radius: 7,
                fill: new ol.style.Fill({
                    color: '#38f'
                }),
                stroke: new ol.style.Stroke({
                    color: '#fff',
                    width: 3
                })
            })
        })
    });
    map.addLayer(markerLayer);

    // Elements that make up the popup.
    const container = document.getElementById('popup');
    const content = document.getElementById('popup-content');
    const closer = document.getElementById('popup-closer');

    // Create an overlay to anchor the popup to the map.
    const overlay = new ol.Overlay({
        element: container,
        autoPan: {
            animation: {
                duration: 250
            }
        }
    });
    map.addOverlay(overlay);

    /**
     * Add a click handler to hide the popup.
     * @return {boolean} Don't follow the href.
     */
    closer.onclick = function () {
        overlay.setPosition(undefined);
        closer.blur();
        return false;
    };

    // Create a 'singleclick' event handler which displays a popup with some basic
    // HTML content.
    map.on('singleclick', function(evt) {
        overlay.setPosition(undefined);
        closer.blur();

        let selectedFeatures = [];

        let feature = map.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
            selectedFeatures.push(feature);
        });

        if( selectedFeatures.length > 0 ) {
            let properties = selectedFeatures[0].get('properties'),
                coord = selectedFeatures[0].getGeometry().getCoordinates();
            showPopup(properties, coord);
        }
    });

    // Use hasFeatureAtPixel() to indicate that the features are clickable by changing
    // the cursor style to 'pointer'.
    map.on('pointermove', function(evt) {
        if( evt.dragging ) return;
        map.getViewport().style.cursor = map.hasFeatureAtPixel(evt.pixel) ? 'pointer' : '';
    });

    // Add an 'onclick' handler for the radio buttons.
    const radios = document.getElementsByName('find');
    for( let i in radios ) {
        radios[i].onclick = function() {
            queryString = this.value;
            getFeatures();
        }
    }

    // Add an 'onchange' handler for the checkboxes.
    const checkboxes = document.getElementsByName('filter');
    for( let i in checkboxes ) {
        checkboxes[i].onchange = function() {
            if( this.id === 'query-fq-bbox' )
                bboxFilter = (this.checked) ? this.value : '';
            if( this.id === 'query-fq-localtype' )
                localTypeFilter = (this.checked) ? this.value : '';
            getFeatures();
        }
    }

    getFeatures();

    /**
     * Get features from the API.
     */
    function getFeatures() {
        const url = 'https://api.os.uk/search/names/v1/find?key=' + apiKey + queryString + bboxFilter + localTypeFilter;

        // Use fetch() method to request any matching placenames (in JSON format).
        // If successful - replace everything in the point layer with new features created
        // by looping the JSON repsonse.
        fetch(url)
            .then(response => response.json())
            .then(data => {
                markerSource.clear(true);

                overlay.setPosition(undefined);
                closer.blur();

                document.getElementById('results').innerHTML = data.header.totalresults;
                if( data.header.totalresults > 100 )
                    document.getElementById('results').innerHTML += ' (showing first 100)';

                document.getElementsByClassName('uri')[0].innerText = decodeURIComponent(data.header.uri);

                data.results.forEach(function(val, i) {
                    let result = val.GAZETTEER_ENTRY;

                    // Transform the geometry values into Web Mercator coordinates.
                    let coord = ol.proj.transform(
                        [ result.GEOMETRY_X, result.GEOMETRY_Y ],
                        'EPSG:27700',
                        'EPSG:3857'
                    );

                    markerSource.addFeature(
                        new ol.Feature({
                            geometry: new ol.geom.Point(coord),
                            properties: {
                                NAME1: result.NAME1,
                                TYPE: result.TYPE,
                                LOCAL_TYPE: result.LOCAL_TYPE
                            }
                        })
                    );
                });
            });
    }

    /**
     * Opens a popup at the location of the click, with some basic HTML content for the
     * feature properties.
     */
    function showPopup(properties, coord) {
        let htmlContent = '<div class="grid-container">';
        for( let i in properties ) {
            htmlContent += `<div>${i}</div><div>${properties[i]}</div>`;
        }
        htmlContent += '</div>';

        content.innerHTML = htmlContent;
        overlay.setPosition(coord);
    }

</script>

</body>
</html>
